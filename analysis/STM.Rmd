---
title: "NLP Project - STM"
output: html_notebook
---

```{r}
library(sf)
library(tidyverse)
library(stm)
library(topicmodels)
library(lda) 
library(quanteda)
library(quanteda.textplots)
library(slam)
library(quanteda)
library(dplyr)
library(ggplot2)


DIR <- '.'
```

# Load data
```{r}
# Load data
lyrics_data <- read.csv(file.path(DIR, '../../data/top songs processed.csv'))
```

```{r}
# Remove all 2 letter words 
lyrics_data$lyrics <- gsub("\\b\\w{2}\\b", "", lyrics_data$lyrics)

# Add ID column 
lyrics_data <- lyrics_data %>%
  mutate(row_num = row_number())

# Build corpus
lyricsCorpus <- corpus(lyrics_data, docid_field = 'row_num', text_field = 'lyrics')

# Tokenize corpus
lyricsCorpus_tokenized <- tokens(lyricsCorpus)

#Convert our tokenized corpus into a documentÃ—term frequency
dfm_lyricsCorpus<- dfm(lyricsCorpus_tokenized)
```


# Plot genre per year

```{r}
# Step 1: Calculate total tags per year
yearly_totals <- lyrics_data %>%
  group_by(release.year) %>%
  summarise(total_tags = n(), .groups = 'drop')

# Step 2: Calculate tag counts per year
tag_counts_per_year <- lyrics_data %>%
  group_by(release.year, tag) %>%
  summarise(tag_count = n(), .groups = 'drop')

# Step 3: Join the totals with the counts and calculate percentages
tag_percentages <- tag_counts_per_year %>%
  left_join(yearly_totals, by = "release.year") %>%
  mutate(percentage = (tag_count / total_tags) * 100)

# Step 4: Plot the data
ggplot(tag_percentages, aes(x = release.year, y = percentage, group = tag, color = tag)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Release Year", y = "Percentage (%)") +
  scale_color_discrete(name = "Genre")

```

# Filter corpus

## Attempt 1

```{r}
# Create custom stop words list
custom_list_stopwords <- c(stopwords("en"))

# Filter corpus
dfm_lyricsCorpus_filtered <- tokens(lyricsCorpus, remove_punct = TRUE, 
                                          remove_symbols = TRUE, remove_numbers = TRUE) %>% 
                            tokens_remove(custom_list_stopwords) %>%
                            tokens_wordstem() %>% 
                            tokens_ngrams(n = c(1, 2)) %>% 
                            dfm() %>% 
                            dfm_tolower() %>% 
                            dfm_trim(min_termfreq = 5, min_docfreq = 0.0025, max_docfreq = 0.99, docfreq_type = "prop")
```


```{r, warning=FALSE}
textplot_wordcloud(dfm_lyricsCorpus_filtered, random_order = FALSE, rotation = 0.25, 
    color = RColorBrewer::brewer.pal(8, "Dark2"))
```

```{r}
# Calculate the document frequency for each term
# This computes how many documents each term appears in
doc_freqs <- docfreq(dfm_lyricsCorpus_filtered)

# Convert to a data frame, sort it, and create a column for term ID or rank
df_doc_freqs <- data.frame(term = names(doc_freqs), doc_freq = doc_freqs) %>%
  arrange(desc(doc_freq)) %>%
  mutate(term_id = row_number())

# Create the plot for document frequencies
ggplot(df_doc_freqs, aes(x = term_id, y = doc_freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Document Frequency Distribution", x = "Term ID", y = "Document Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) # Hide x-axis text for clarity

```
## Attempt 2
```{r}
# Filter corpus
dfm_lyricsCorpus_filtered <- tokens(lyricsCorpus, remove_punct = TRUE, 
                                          remove_symbols = TRUE, remove_numbers = TRUE) %>% 
                            tokens_remove(custom_list_stopwords) %>%
                            tokens_wordstem() %>% 
                            tokens_ngrams(n = c(1, 2)) %>% 
                            dfm() %>% 
                            dfm_tolower() %>% 
                            dfm_trim(min_termfreq = 5, min_docfreq = 480, max_docfreq = 30000)
```


```{r, warning=FALSE}
textplot_wordcloud(dfm_lyricsCorpus_filtered, random_order = FALSE, rotation = 0.25, 
    color = RColorBrewer::brewer.pal(8, "Dark2"))
```


```{r}
# Calculate the document frequency for each term
# This computes how many documents each term appears in
doc_freqs <- docfreq(dfm_lyricsCorpus_filtered)

# Convert to a data frame, sort it, and create a column for term ID or rank
df_doc_freqs <- data.frame(term = names(doc_freqs), doc_freq = doc_freqs) %>%
  arrange(desc(doc_freq)) %>%
  mutate(term_id = row_number())

# Create the plot for document frequencies
ggplot(df_doc_freqs, aes(x = term_id, y = doc_freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Document Frequency Distribution", x = "Term ID", y = "Document Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) # Hide x-axis text for clarity
```

# Run STM

```{r}
# Assuming dfm_lyricsCorpus_filtered is your document-term matrix
non_empty_docs <- which(rowSums(dfm_lyricsCorpus_filtered) > 0)

# Filter your DFM to keep only non-empty documents
dfm_lyricsCorpus_filtered <- dfm_lyricsCorpus_filtered[non_empty_docs, ]

# Prepare the metadata for STM
meta_data <- data.frame(date = lyrics_data$release.year, genre = lyrics_data$tag)
meta_data <- meta_data[non_empty_docs, ]
```

```{r}
# Run the STM model
stm_model <- stm(documents = dfm_lyricsCorpus_filtered, 
                 data = meta_data, 
                 K = 20, 
                 prevalence = ~ s(date) + genre + s(date)*genre, 
                 seed = 123, init.type = "Spectral")
```


```{r}
topic_labels <- c("Vocal Expressions: ", "Love and Affection: ", "Feelings and Friendship: ", "Conversational and Familial References: ", "Journey and Celebration: ", "Darker Imagery: ", "Aspiration and Motivation: ", "Party and Energy: ", "Masculinity and Identity: ", "Change and Departure: ", "Desire and Yearning: ", "Rebellion and Explicit Content: ", "Reflection and Time: ", "Spirituality and Destiny: ", "Sociopolitical Commentary: ", "Romantic and Playful Affections: ", "Challenges and Aspirations: ", "Celebration and Optimism: ", "Exclamations and Emphasis: ", "Knowledge and Discovery: ")

plot(stm_model, type="summary", topic.names = topic_labels, text.cex = 0.7)
```



```{r}
labelTopics(stm_model, n = 7)
```

1. **Vocal Expressions**: This topic seems to capture songs that heavily feature vocal adlibs like "ooh," "woo," and "mmm," often associated with feelings of awe or the magical moments in music.

2. **Love and Affection**: Centered around the theme of love, this topic includes words that express deep affection, romantic desires, and the joy and pain of love.

3. **Feelings and Friendship**: This topic revolves around the expression of feelings, both good and bad, and the importance of friendship, highlighting songs that discuss emotional experiences and the value of close relationships.

4. **Conversational and Familial References**: Featuring words like "say," "hey," "mama," and "daddy," this topic likely includes songs with conversational tones or those addressing family members directly, evoking a sense of dialogue or personal stories.

5. **Journey and Celebration**: This topic suggests themes of coming home, dancing, singing, and the general celebration of life's journey, encapsulating songs that are about movement, joy, and homecoming.

6. **Darker Imagery**: With words like "eye," "light," "burn," and "die," this topic delves into darker or more introspective themes, possibly touching on loss, despair, or the more somber aspects of life.

7. **Aspiration and Motivation**: This theme focuses on encouragement, striving for greatness, and never giving up, with words like "let," "high," and "move" indicating a push towards overcoming obstacles and achieving goals.

8. **Party and Energy**: Highlighting the vibrant aspects of music, this topic is all about the party scene, with references to "rock," "beat," and "parti," pointing towards energetic, upbeat songs designed to get listeners moving.

9. **Masculinity and Identity**: With words like "like," "man," "boy," and "car," this topic explores themes of masculinity, identity, and perhaps the societal expectations of men, often in a playful or contemplative manner.

10. **Change and Departure**: Focused on themes of change, leaving, and moving on, this topic includes words related to transitions, such as "take," "away," "back," and "walk," reflecting on the process of change and the emotions involved.

11. **Desire and Yearning**: This topic addresses the deep human desires for connection, freedom, and being understood, with "want," "need," and "nobodi" highlighting the longing and search for fulfillment.

12. **Explicit Content and Rebellion**: Featuring explicit language and themes, this topic is likely associated with songs that challenge societal norms, express frustration, or embrace a rebellious spirit.

13. **Reflection and Time**: Centering around "time," "life," and "day," this topic reflects on the passage of time, life's journey, and the moments that shape our existence, often in a contemplative or nostalgic tone.

14. **Spirituality and Destiny**: With references to "god," "jesus," and "one," this topic explores spiritual themes, faith, and the quest for meaning and purpose in life.

15. **Sociopolitical Commentary**: Addressing "people," "world," "black," and "war," this topic is rich with songs that comment on social issues, political struggles, and the human condition, often aiming to inspire change or awareness.

16. **Romantic and Playful Affections**: This topic is filled with affectionate terms like "babi," "girl," and "wanna," likely featuring songs that express love, desire, and playful romantic intentions.

17. **Street Life, Ambition, and Explitives**: With words like  "money," and "shit," this topic delves into the realities of street life, ambition, and the pursuit of success, often with a raw, unfiltered lens.

18. **Celebration and Optimism**: Focused on "right," "night," and "tonight," this topic captures the essence of living in the moment, celebrating life, and embracing the possibilities of the night.

19. **Exclamations and Emphasis**: Utilizing words like "yeah," "huh," and "whoa," this topic emphasizes songs that use these exclamations to convey enthusiasm, surprise, or agreement, often in a catchy or memorable way.

20. **Knowledge and Discovery**: This topic, with words like "know," "tell," and "think," explores themes of understanding, revelation, and the pursuit of truth, reflecting on the process of learning and sharing knowledge.

# Topics over time

```{r}
time_effect <- estimateEffect(1:20 ~ s(date), stm_model, meta = meta_data, uncertainty = "Global")
```


```{r}
plot(time_effect, "date", method = "continuous", topics = c(1, 2, 3, 4, 5, 7, 8, 9, 10) ,model = time_effect, printlegend = TRUE)
```
## Optimise for K

```{r}
# Optimise for K
system.time(
  searchK <- searchK(documents = dfm_lyricsCorpus_filtered, 
                     K = c(10,15, 20, 25, 30,40), #specify K to try
                      N = 4800, # Use 10% of observations to determine optimum number of topics
                     proportion = 0.5, # hold out 50% to use for testing
                     heldout.seed = 1234, 
                     M = 10, # number of random initializations to perform
                     cores = 1, # default
                     prevalence =~ s(date) + genre + s(date)*genre,
                     max.em.its = 75, # Max iterations
                     data = meta_data,
                     init.type = "Spectral",
                     verbose=TRUE)
)
```

```{r}
# Extracting the data from the searchK list
K_values <- searchK$results$K  
heldout_likelihood <- searchK$results$heldout
semcoh <- searchK$results$semcoh

# Creating a data frame for plotting
plot_data <- data.frame(
  K = unlist(K_values),
  HeldOutLikelihood = unlist(heldout_likelihood),
  semcoh = unlist(semcoh)
)

# Plot for Held-Out Likelihood
ggplot(plot_data, aes(x = K, y = HeldOutLikelihood)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Number of Topics (K)",
       y = "Held-Out Likelihood")

# Plot for Semantic coherance
ggplot(plot_data, aes(x = K, y = semcoh)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Number of Topics (K)",
       y = "Semantic Coherance")
```

